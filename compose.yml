version: '3.8' # Version de la spécification Compose

services:
  # ----------------------------------------------------
  # SERVICE 1: Base de Données (MariaDB)
  # ----------------------------------------------------
  db:
    image: docker.io/library/mariadb:10.6 # Nom d'image complet pour éviter l'erreur Podman
    container_name: lahar-db
    restart: always
    environment:
      # Les valeurs sont chargées depuis le fichier .env
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db-data:/var/lib/mysql # Volume nommé pour la persistance des données de la DB
    networks:
      - prestashop-net

  # ----------------------------------------------------
  # SERVICE 2: Application PrestaShop
  # ----------------------------------------------------
  prestashop:
    image: docker.io/prestashop/prestashop:latest 
    container_name: lahar-app
    depends_on: 
      - db
    restart: always 
    ports: 
      - "8080:80" # Mapping du port
    
    # CORRECTION DE L'ERREUR DE PERMISSION (Option 1: root)
    user: "0" # <-- AJOUT : Exécute le conteneur en tant que root pour avoir les droits de renommage sur le Bind Mount

    environment: # Variables d'environnement pour configurer PrestaShop
      DB_SERVER: db # Nom du service pour la communication
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      
    volumes:
      # BIND MOUNT pour le développement local et la persistance des fichiers
      - ./prestashop-code:/var/www/html 
      
    networks:
      - prestashop-net

volumes: # Définition des volumes nommés
  db-data:

networks: # Définition des réseaux
  prestashop-net:
    driver: bridge